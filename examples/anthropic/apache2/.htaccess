# Flag Anthropic IPs (generate these lines or maintain by hand)
# Example static:
SetEnvIfExpr "ipmatch(remote_addr, '160.79.104.0/23')"  ANTH_IP=1
SetEnvIfExpr "ipmatch(remote_addr, '2607:6bc0::/48')"   ANTH_IP=1
# (Or: IncludeOptional /etc/apache2/anthropic-ipmatch.conf)

# UA contains "Anthropic"?
SetEnvIfNoCase User-Agent "Anthropic" ANTH_UA=1

# Classes
SetEnvIfExpr "env('ANTH_IP') == '1' && env('ANTH_UA') != '1'" ANTH_BAD=1
SetEnvIfExpr "env('ANTH_IP') == '1' && env('ANTH_UA') == '1'" ANTH_GOOD=1
SetEnvIfExpr "env('ANTH_IP') != '1' && env('ANTH_UA') == '1'" ANTH_SPOOF=1

# Dedicated logs (avoid double-logging: main access log excludes these envs)
CustomLog logs/access_log      combined env=!ANTH_BAD env=!ANTH_GOOD env=!ANTH_SPOOF
CustomLog logs/anthropic_bad.log   combined env=ANTH_BAD     # 1) bad
CustomLog logs/anthropic_good.log  combined env=ANTH_GOOD    # 2) good
CustomLog logs/anthropic_spoof.log combined env=ANTH_SPOOF   # 3) spoof

# Optional: quiet message for "bad"
RewriteEngine On
RewriteCond %{ENV:ANTH_BAD} =1
RewriteRule ^ - [L,E=ANTHMSG:1]
Header set Cache-Control "no-store" env=ANTHMSG
Header set Content-Type "text/plain" env=ANTHMSG
ErrorDocument 200 "Stop scraping. Identify your client as Anthropic."
RewriteRule ^ - [L,R=200,env=ANTHMSG]
