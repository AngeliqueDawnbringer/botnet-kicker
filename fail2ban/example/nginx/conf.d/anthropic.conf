# This file lives in http{} via: include /etc/nginx/conf.d/*.conf;

# --- Identify Anthropic IPs (from an include you generate) ---
geo $anthropic_ip {
    default 0;
    include /etc/nginx/anthropic.ranges;   # <- maintained by you
}

# --- UA says "Anthropic"? (case-insensitive) ---
map $http_user_agent $anthropic_ua {
    default 0;
    ~*anthropic 1;
}

# --- Classification flags ---
# 1) From Anthropic IPs but UA is not Anthropic  -> "bad"
map "$anthropic_ip:$anthropic_ua" $anthropic_bad   { "1:0" 1; default 0; }
# 2) From Anthropic IPs and UA is Anthropic       -> "good"
map "$anthropic_ip:$anthropic_ua" $anthropic_good  { "1:1" 1; default 0; }
# 3) Not Anthropic IPs but UA claims Anthropic    -> "spoof"
map "$anthropic_ip:$anthropic_ua" $anthropic_spoof { "0:1" 1; default 0; }

# --- Dedicated logs (optional, keeps main access log tidy) ---
log_format anthua '$remote_addr [$time_local] "$request" $status $body_bytes_sent '
                  '"$http_referer" "$http_user_agent"';
access_log /var/log/nginx/anthropic_bad.log   anthua if=$anthropic_bad;
access_log /var/log/nginx/anthropic_good.log  anthua if=$anthropic_good;
access_log /var/log/nginx/anthropic_spoof.log anthua if=$anthropic_spoof;
